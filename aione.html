<html>
    <head>
        <title>All in One Recorder</title>
    </head>
    <body>
        <h1>All in One Recorder</h1>
        <author>HanishKVC</author>
        <version>v20230702IST2255</version>
        <p>
            <button id="RecScr"> Record Screen </button>
            <button id="RecDev"> Record Devices </button>
            <button id="RecAud"> Record Audio </button>
            <button id="RecStop"> Stop </button>
        </p>
        <p id="Status">
        </p>
        <script>
            let theStream = null
            let mediaRec = null;
            let mediaChunks = []
            let dataChunkCnt = 0
            let fileData = null
            const DATACHUNK_MS = 20000
            let mediaFileCnt = 0
            let dl = null
            let elStatus = null
            let startDateTime = 3210
            let saveChunks = false
            let recType = "???"

            function got_data(be) {
                mediaChunks.push(be.data)
                dataChunkCnt += 1
                console.log("INFO:GotData:", dataChunkCnt)
                elStatus.innerHTML = `Recording ${recType}... ${dataChunkCnt}`
                if (saveChunks) {
                    save_chunks()
                }
            }

            function prep_mr(stream, options={}) {
                saveChunks = false
                mediaChunks = []
                dataChunkCnt = 0
                theStream = stream
                mediaFileCnt += 1
                mediaRec = new MediaRecorder(stream, options)
                mediaRec.ondataavailable = got_data
                mediaRec.start(DATACHUNK_MS)
                startDateTime = Date.now()
            }

            function start_rs(params) {
                navigator.mediaDevices.getDisplayMedia({audio: true, video: true}).then((stream)=>{
                    recType = "screen"
                    prep_mr(stream, {audioBitsPerSecond: 64000, videoBitsPerSecond: 512000})
                    elStatus.innerHTML = "Started screen recording..."
                    console.log("INFO:RecScr:Started...")
                })
            }

            function start_rd(params) {
                navigator.mediaDevices.getUserMedia({audio: true, video: true}).then((stream)=>{
                    recType = "devices"
                    prep_mr(stream)
                    elStatus.innerHTML = "Started device recording..."
                    console.log("INFO:RecDev:Started...")
                })
            }

            function start_ra(params) {
                navigator.mediaDevices.getUserMedia({audio: true}).then((stream)=>{
                    recType = "audio"
                    prep_mr(stream)
                    elStatus.innerHTML = "Started audio recording..."
                    console.log("INFO:RecAud:Started...")
                })
            }

            function save_chunks() {
                console.log(`INFO:SaveChunks:${recType}:NumOfMediaChunks:`, mediaChunks.length)
                if (fileData !== null) {
                    window.URL.revokeObjectURL(fileData)
                }
                let dataBlob = new Blob(mediaChunks)
                fileData = window.URL.createObjectURL(dataBlob)
                if (dl !== null) {
                    window.document.body.removeChild(dl)
                }
                dl = document.createElement('a')
                dl.id = "SaveLink"
                dl.setAttribute('download', `captured_${startDateTime}_${mediaFileCnt}`)
                dl.href = fileData
                dl.innerHTML = "Save captured media"
                window.document.body.appendChild(dl)
                elStatus.innerHTML = `Captured ${recType} data prepared for saving...`
            }

            function stop_rec(params) {
                if (mediaRec !== null) {
                    mediaRec.stop()
                    mediaRec = null
                    elStatus.innerHTML = `Stopped recording ${recType}...`
                    console.log("INFO:RecStop:Stopped recording...")
                    saveChunks = true
                } else {
                    elStatus.innerHTML = "Nothing to stop..."
                    console.log("INFO:RecStop:Nothing to stop...")
                }
            }

            function init (params) {
                let brs = document.getElementById("RecScr")
                brs.onclick = start_rs
                let brd = document.getElementById("RecDev")
                brd.onclick = start_rd
                let bra = document.getElementById("RecAud")
                bra.onclick = start_ra
                let brstop = document.getElementById("RecStop")
                brstop.onclick = stop_rec
                console.log("INFO:Init:Setup UI...")
                elStatus = document.getElementById("Status")
            }
            window.onload = init
        </script>
    </body>
</html>
